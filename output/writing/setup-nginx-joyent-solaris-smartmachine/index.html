<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<link href='/static/css/application.css' media='screen' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Alegreya:400italic,400,700|Inconsolata' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<script type="text/javascript">
    // first, create the object that contains
    // configuration variables
    MTIConfig = {};

    // next, add a variable that will control
    // whether or not FOUT will be prevented
    MTIConfig.EnableCustomFOUTHandler = true // true = prevent FOUT
</script>
<title>
Setup Nginx on Joyent's Solaris SmartMachine | Evan Carmi
</title>
<link href="/writing/feed.xml" type="application/atom+xml" rel="alternate" title="Writing ATOM Feed">
<meta content='nanoc' name='generator'>
<meta content='Evan Carmi' name='author'>
<meta content='A guide to setting up Nginx on a Joyent SmartMachine.' name='description'>
</head>
<body>
<div class='container'>
<header class='post'>
<div class='header-contents'>
<hgroup class='article-metadata'>
By
<span class='author'>
<a href='https://ecarmi.org'>
Evan Carmi
</a>
</span>
&#183;
<span class='post-date'>
Posted
<time class="timeago created-at" datetime="2011-08-11T00:00:00-07:00">August 11, 2011</time>
</span>
</hgroup>
<h1 class='title'>Setup Nginx on Joyent's Solaris SmartMachine</h1>
</div>
</header>
<article class='post'>

<h2 id="smartmachine--solaris--ubuntu">SmartMachine == Solaris != Ubuntu</h2>

<p>I recently setup Nginx on my Joyent <a href="http://www.joyent.com/software/smartmachines/">SmartMachine</a>. A SmartMachine is just a <a href="http://en.wikipedia.org/wiki/Solaris_(operating_system)">Solaris</a> box. However, Solaris ain’t Ubuntu. You don’t have any <a href="http://en.wikipedia.org/wiki/Advanced_Packaging_Tool">super cow powers</a> and things are in a slightly different spot.</p>

<p>Unfortunately, Joyent has <strike>no</strike>little <a href="http://wiki.joyent.com/display/smart/SmartMachines+Home">documentation</a>, and Solaris, like all non-Ubuntu OS’s has documentation that often leaves something to be desired.</p>

<h2 id="disable-apache">Disable Apache</h2>

<p>First off, you need to disable Apache so Nginx can have port 80 all to itself.</p>

<p>To do this you need to use the <a href="http://wiki.joyent.com/display/smart/About+the+Service+Management+Facility">service management facility</a> built into Solaris. While, right now, I’m much more comfortable with upstart and init.d, I think that services might be a decent Solaris functionality. But we will have to see.</p>

<p>Nonetheless, to see all running services run:</p>

<pre><code>svcs -a
STATE          STIME    FMRI
legacy_run      0:20:04 lrc:/etc/rc2_d/S20sysetup
legacy_run      0:20:04 lrc:/etc/rc2_d/S72autoinstall
legacy_run      0:20:04 lrc:/etc/rc2_d/S89PRESERVE
legacy_run      0:20:04 lrc:/etc/rc2_d/S98deallocate
...
</code></pre>

<p>You should see a list of online and disabled services. To modify these, use the <code>svcadm</code> command.</p>

<pre><code>sudo svcadm disable apache
</code></pre>

<h2 id="install-nginx">Install Nginx</h2>

<p>Great. Now we can focus on Nginx.</p>

<p>Note: If you have never talked outloud about Nginx you may not know that it’s pronounced <a href="http://wiki.nginx.org/Faq#How_do_you_pronounce_.22Nginx.22.3F">Engine-X</a>. That’ll make reading this article in your head easier :)</p>

<p>Nginx is probably already installed on your SmartMachine, but to check you can use <code>pgkin</code>.</p>

<p>If installed you’ll see:</p>

<pre><code>$ pkgin install nginx
calculating dependencies for nginx...
nothing to do.
</code></pre>

<p>And let’s enable it:</p>

<pre><code>$ sudo svcadm enable nginx
</code></pre>

<p>Now, to confirm it’s online:</p>

<pre><code>$ svcs -a | grep nginx
online          0:20:03 svc:/network/http:nginx
</code></pre>

<p>Awesome.</p>

<p>If you ran into some issues and are unsure whether Nginx or apache is running try curl’ing localhost with the -I (send a INFO http request) to see the server type:</p>

<pre><code>$ curl -I localhost
HTTP/1.1 200 OK
Server: nginx
Date: Mon, 18 Jul 2011 02:16:25 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 5031
Last-Modified: Sun, 17 Jul 2011 23:03:46 GMT
Connection: keep-alive
Accept-Ranges: bytes
</code></pre>

<p>Superb. We now have Nginx running on your SmartMachine. You might think that this so far is easy (and it is), but <a href="http://lmgtfy.com/?q=install+nginx+on+joyent+smart+machine">a quick search</a> actually has few simple guides or docs on how to get this far.</p>

<h2 id="configure-nginx">Configure Nginx</h2>

<p>Okay, so first off, you’ll be searching and searching for you Nginx configuration files.</p>

<p>We can find the default directories and files with:</p>

<pre><code>$ nginx -V
nginx version: nginx/0.8.41
TLS SNI support enabled
configure arguments: --user=www --group=www --with-ld-opt='-L/opt/local/lib -Wl,-R/opt/local/lib' --prefix=/opt/local --sbin-path=/opt/local/sbin --conf-path=/opt/local/etc/nginx/nginx.conf --pid-path=/var/db/nginx/nginx.pid --lock-path=/var/db/nginx/nginx.lock --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/db/nginx/client_body_temp --http-proxy-temp-path=/var/db/nginx/proxy_temp --http-fastcgi-temp-path=/var/db/nginx/fstcgi_temp --with-http_ssl_module --with-http_dav_module --with-http_realip_module --with-http_stub_status_module
</code></pre>

<p>Great, what do we see?
the place to be /opt/local/etc/nginx/nginx.conf</p>

<p>Okay, so we go look at that in our editor of choice (vim, of course).</p>

<p>So we have a basic Nginx configuration. But we want a quality setup! We want to have multiple domains running on the same Nginx instance with separate configuration files. So let’s set that up.</p>

<p>Most systems come with a sites-enabled and sites-available setup. The version you install with pkgin on Solaris sadly does not. But, there is no magic to those directories, so let’s create them ourselves.</p>

<p>Recalling your Nginx 101 course, sites-available/ is a directory of all the possible site configuration files. Then, when you want to enable a site, you create a symlink (<code>ln -s</code>) from sites-available to sites-enabled.</p>

<p>We create those two directories next to where the default nginx.conf file lives.</p>

<pre><code>$ sudo mkdir -p /opt/local/etc/nginx/sites-enabled
$ sudo mkdir -p /opt/local/etc/nginx/sites-available
</code></pre>

<p>Okay, now it’s configuration time!</p>

<p>We can leave most of our default nginx.conf file the way it is. But the key line we need to add (unless it is already present in your conf) is:</p>

<pre><code>include /etc/nginx/sites-enabled/*;
</code></pre>

<p>This little include can be placed anywhere insude the http {} block</p>

<p>So my config file looks like:</p>

<pre><code>$ cat nginx.conf 
user www www;
worker_processes 1;
error_log /var/log/nginx/error.log;
pid /var/spool/nginx/nginx.pid;

events {
        worker_connections 1024;
        use /dev/poll; # important on Solaris
}

http {
        include /opt/local/etc/nginx/mime.types;
        default_type application/octet-stream;
        log_format main '$remote_addr - $remote_user [$time_local] $request '
                        '"$status" $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';
        access_log /var/log/nginx/access.log main;
        sendfile off; # important on Solaris
        keepalive_timeout 60;
        server_tokens off; #       gzip on; #       gzip_http_version 1.0; #       gzip_comp_level 2; #       gzip_proxied any; #       gzip_types text/plain text/html text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        include /opt/local/etc/nginx/sites-enabled/*;
        server {
                listen 80;
                # Defaults to hostname #               server_name fgad8daa.joyent.us;
                charset utf-8;
                access_log /home/jill/logs/nginx.access.log main;
                location / {
                        root /home/jill/web/public;
                        index index.html index.php maintenance.html;
                }

                # proxy the PHP scripts to Apache listening on 127.0.0.1:80 #               location ~ \.php$ { #                       proxy_pass http://127.0.0.1; #               }

                # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 #               location ~ \.php$ { #                       fastcgi_pass 127.0.0.1:9000; #                       fastcgi_index index.php; #                       fastcgi_param SCRIPT_FILENAME /home/jill/web/public$fastcgi_script_name; #                       include /opt/local/etc/nginx/fastcgi_params; #               }

                location ~ /\.ht {
                        deny all;
                }

                error_page 500 502 503 504 /50x.html;
                location = /50x.html {
                        root share/examples/nginx/html;
                }
        }

        server {
                listen 443;
                # Defaults to hostname #               server_name fgad8daa.joyent.us;
                ssl on;
                ssl_certificate /opt/local/etc/openssl/private/selfsigned.pem;
                ssl_certificate_key /opt/local/etc/openssl/private/selfsigned.pem;
                ssl_prefer_server_ciphers on;

                location / {
                        root /home/jill/web/public;
                        index index.php maintenance.html;
                }

                location ~ /\.ht {
                        deny all;
                }

                error_page 500 502 503 504 /50x.html;
                location = /50x.html {
                        root share/examples/nginx/html;
                }
        }
}
</code></pre>

<p>So I added mine right before the <code>server{}</code> block. I’m not sure what the best practice for placing this include is, but this makes logical sense, you import your settings, and then can override any of them below. This way it’s easier to debug and you won’t have something that’s getting included overwriting your main config.</p>

<p>Let’s create some sites!</p>

<p>We simply create a file in our sites-available directory.</p>

<pre><code>$ sudo vim /opt/local/etc/nginx/sites-available/staging.conf
</code></pre>

<p>And my file looks like:</p>

<pre><code>server {
      listen 80;
      # Defaults to hostname
      server_name staging.ecarmi.org;
      charset utf-8;
      access_log /home/jill/www/sites/staging/logs/nginx.access.log main;
      location / {
              root /home/jill/www/sites/staging/web/public;
              index index.html;
      }

      location ~ /\.ht {
              deny all;
      }

      error_page 500 502 503 504 /50x.html;
      location = /50x.html {
              root share/examples/nginx/html;
      }
}
</code></pre>

<p>And very importantly, we need to symlink this file to sites-enabled.</p>

<pre><code>$ sudo ln -s /opt/local/etc/nginx/sites-available/staging.conf /opt/local/etc/nginx/sites-enabled/
</code></pre>

<p>Now, we need to point a DNS record to the server. I use dnsmadeeasy, so I needed to create an A record of staging.ecarmi.org. that points to 8.12.36.10 which is the public ip address of the server.</p>

<p>Note, it may take a few minutes for the DNS changes to propagate.</p>

<h2 id="create-a-directory-structure">Create a Directory Structure</h2>

<p>Now we need to create all those directories in the home folder and place our content there. Jill is the default user on Joyent SmartMachines, but the strucutre can be whatever.</p>

<p>So in jill’s home directory we will create a www/sites structure and then the name of the domain. And for each domain we will need a web/public and logs/ directories</p>

<pre><code>$ mkdir -p ~/www/sites/staging/web/public/
$ mkdir -p ~/www/sites/staging/logs
</code></pre>

<p>Great, and let’s place our fancy website in the web/public directory.</p>

<pre><code>$ echo "hello staging server" &gt; ~/www/sites/staging/web/public/index.html
</code></pre>

<p>And, don’t forget to restart nginx. We really only need it to reload it’s configuartion settings, so <code>sudo nginx -s reload</code> should do the trick. If this doesn’t work, you can of course, restart the whole thing.</p>

<p>Let’s see if it worked. From you local computer</p>

<pre><code>$ curl staging.ecarmi.org
hello staging server
</code></pre>

<p>There it is, it worked. cURL is great to use for testing this kind of stuff out because it doesn’t cache anything.</p>

<p>Okay, now let’s create another site.</p>

<h3 id="step-one-create-the-directory-structure-and-files">Step one: create the directory structure and files:</h3>

<pre><code>$ mkdir -p ~/www/sites/prod/logs                             
$ mkdir -p ~/www/sites/prod/web/public
$ echo "hello production server" &gt; ~/www/sites/prod/web/public/index.html
</code></pre>

<p>and we can also copy over our previous configuration file substituting prod for staging:</p>

<pre><code>$ sudo cp /opt/local/etc/nginx/sites-available/staging.conf /opt/local/etc/nginx/sites-available/prod.conf
</code></pre>

<p>And don’t forget to use vim (or sed) to change staging to prod.</p>

<p>Then symlink prod from sites-available to sites-enabled</p>

<pre><code>$ sudo ln -s /opt/local/etc/nginx/sites-available/prod.conf /opt/local/etc/nginx/sites-enabled/
</code></pre>

<h3 id="step-two">Step two:</h3>

<p>Create a DNS A record of prod.ecarmi.org point to the same ip address, replacing ecarmi.org with your own domain.</p>

<h3 id="step-three">Step three:</h3>

<p>have Nginx reload it’s configuration settings</p>

<pre><code>$ sudo nginx -s reload
</code></pre>

<p>or if you want to use svcadm magic</p>

<pre><code>$ sudo svcadm refresh nginx
</code></pre>

<p>and then back to curl</p>

<pre><code>$ curl prod.ecarmi.org
  hello production server
$ curl staging.ecarmi.org    
  hello staging server
</code></pre>

<p>You are good to go!</p>


<p class='prev'>
<a class="previous" title="How I (almost) got an internship at Google" href="/writing/google-internship/">&larr; Previous</a>
</p>
<p class='next'>
<a class="next" title="Password Protect Nginx Virtualhost" href="/writing/password-protect-nginx/">Next &rarr;</a>
</p>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
 var disqus_developer = 1; // developer mode is on
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ecarmi'; // required: replace example with your forum shortname

  // The following are highly recommended additional parameters. Remove the slashes in front to use.
  var disqus_identifier = '/writing/setup-nginx-joyent-solaris-smartmachine/';
  var disqus_title = 'Setup Nginx on Joyents Solaris SmartMachine';
  var disqus_url = 'https://ecarmi.org/writing/setup-nginx-joyent-solaris-smartmachine/';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</article>

</div>
<footer>
<div class='footer-div'>
<div class='footer-contents'>
<section>
<aside>
<h6>Whose site is this?</h6>
</aside>
<article>
<p>This is the digital abode of Evan Carmi. <a title="About" href="/about/">Moreover...</a>.</p>
</article>
</section>
<section>
<aside>
<h6>Have thoughts?</h6>
</aside>
<article>
<form id="contact-form" action="//murmuring-gorge-6133.herokuapp.com/c7fb810ab62eafa93d1683aa5e3d9877" method="POST">
    <input type="email" name="replyto" placeholder="Place email here...">
    <textarea name="message" rows="1" placeholder="Place opinion here..."></textarea>
    <input type="text" name="_gotcha" style="display:none">
    <input type="hidden" name="subject" value="[submission] Hello from ecarmi.org" />
    <input type="submit" value="Send">
</form>
</article>
</section>
<section>
<aside>
<h6>How was the site made?</h6>
</aside>
<article>
<p>Evan Carmi designed and coded this site by hand with love in <a href="https://github.com/carmi/dotfiles/blob/master/.vimrc">Vim</a>.  It is powered by <a href="http://nanoc.stoneship.org/">Nanoc</a> and served by <a href="http://nginx.org/">Nginx</a> on the <a href="http://joyent.com/">Joyent Cloud</a>. The complete source code is <a href="https://github.com/carmi/ecarmi.org-nanoc">online</a>.</p>
</article>
</section>
</div>
<p class='social-links'>
<a title="Home" href="/"><i class="fa fa-home"></i></a>
<a title="Github" rel="me" href="https://github.com/carmi/"><i class="fa fa-github"></i></a>
<a title="Twitter" rel="me" href="https://twitter.com/ehc"><i class="fa fa-twitter"></i></a>
<a title="LinkedIn" rel="me" href="http://www.linkedin.com/in/evancarmi"><i class="fa fa-linkedin"></i></a>
</p>
</div>
</footer>

<!-- / Javascript -->
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src='/static/js/combined.js' type='text/javascript'></script>
<!-- GA -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-27458554-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End GA -->

<script type='text/javascript'>
jQuery(document).ready(function() {
jQuery("time.timeago").timeago();
});
</script>
</body>
</html>
