<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<link href='/static/css/application.css' media='screen' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Alegreya:400italic,400,700|Inconsolata' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<script type="text/javascript">
    // first, create the object that contains
    // configuration variables
    MTIConfig = {};

    // next, add a variable that will control
    // whether or not FOUT will be prevented
    MTIConfig.EnableCustomFOUTHandler = true // true = prevent FOUT
</script>
<title>
Manage Resque Job Queues in YAML | Evan Carmi
</title>
<link href="/writing/feed.xml" type="application/atom+xml" rel="alternate" title="Writing ATOM Feed">
<meta content='nanoc' name='generator'>
<meta content='Evan Carmi' name='author'>
<meta content='Ruby metaprogramming + Resque + YAML = one slick configuration file.' name='description'>
</head>
<body>
<div class='container'>
<header class='post'>
<div class='header-contents'>
<hgroup class='article-metadata'>
By
<span class='author'>
<a href='https://ecarmi.org'>
Evan Carmi
</a>
</span>
&#183;
<span class='post-date'>
Posted
<time class="timeago created-at" datetime="2013-08-11T00:00:00-07:00">August 11, 2013</time>
</span>
</hgroup>
<h1 class='title'>Manage Resque Job Queues in YAML</h1>
</div>
</header>
<article class='post'>
<h2 id="one-config-to-rule-them-all">One config to rule them all</h2>

<p>This post is about a neat trick to manage all of the queue declarations for many Resque Jobs in a single configuration file using a tad of metaprogramming.</p>

<h2 id="resque-introduction">Resque Introduction</h2>

<p><a href="https://github.com/resque/resque/">Resque</a> (pronounced like “rescue”) is a Redis-backed library for creating background jobs, placing those jobs on multiple queues, and processing them later. A typical job class looks like this:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">HighPriorityJob</span> &lt; <span style="color:#036;font-weight:bold">BaseJob</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#33B">@queue</span> = <span style="color:#A60">:high</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">perform</span>(args)
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>    <span style="color:#777"># code to do some work</span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n7" name="n7">7</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>And then you can enqueue the job for processing later with <code>Resque.enqueue(HighPriorityJob, args)</code>. Now you have some workers that run the jobs on each queue. Some jobs are more important than others so you end up with a few different queues. Maybe a <code>high</code>, <code>medium</code>, and <code>low</code> queue relating to the priority of each job.</p>

<p>This is all fine and dandy for a few jobs. But sometimes your codebase grows and you end up with many different job classes. In this case it can get unwieldy to define each queue in the class itself. Wouldn’t it be nice if you could define which queue any given job runs on in a central YAML file? You could then easily see which jobs run on which queues, easily change which jobs run on which queues, and reduce duplication. Let’s do it!</p>

<p>Let’s assume we have a bunch of jobs including these:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MediumPriorityJob</span> &lt; <span style="color:#036;font-weight:bold">BaseJob</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#33B">@queue</span> = <span style="color:#A60">:medium</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">perform</span>(args)
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LowPriorityJob</span> &lt; <span style="color:#036;font-weight:bold">BaseJob</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#33B">@queue</span> = <span style="color:#A60">:low</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">perform</span>(args)
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OtherPriorityJob</span> &lt; <span style="color:#036;font-weight:bold">BaseJob</span>
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#33B">@queue</span> = <span style="color:#A60">:low</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">perform</span>(args)
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>The majority of jobs run on the <code>low</code> queue and this seems like a good default queue for us. Then whenever we have a special job that needs to be run on a separate queue we can define it separately. Let’s imagine what we would want a YAML file to look like:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#606">job_queues</span>:
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#777"># Defaults for all jobs if not specified</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  <span style="color:#606">default_queue</span>:
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>    <span style="color:#F00;background-color:#FAA">"low"</span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  <span style="color:#606">high_priority_job</span>:
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>    <span style="color:#606">queue</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">high</span><span style="color:#710">"</span></span>
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>  <span style="color:#606">medium_priority_job</span>:
<span class="line-numbers"><a href="#n8" name="n8">8</a></span>    <span style="color:#606">queue</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">medium</span><span style="color:#710">"</span></span>
</pre></div>
</div>
</div>

<p>Great, let’s settle on <a href="http://api.rubyonrails.org/classes/ActiveSupport/Inflector.html#method-i-underscore">underscore</a>‘ing our class names in the YAML file, so ThisIsMyClass becomes this_is_my_class. (If you are not using rails you’ll have to supply your own <code>#underscore</code> method.)</p>

<p>Cool, now I find it handy to combine this with the definitions of workers, so I placed that YAML into my resque-pool.yml. But you can place it wherever. Then adding it to our app is as easy as doing a <code>YAML.load</code> on the file in your app setup. If you’re running on Rails then in an initializer would do the trick. Something like this will work for Rails:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#036;font-weight:bold">Resque</span>::<span style="color:#036;font-weight:bold">RESQUE_JOB_QUEUES</span> = <span style="color:#036;font-weight:bold">YAML</span>.load_file(<span style="color:#036;font-weight:bold">Rails</span>.root.join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">config/resque-pool.yml</span><span style="color:#710">'</span></span>))[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">job_queues</span><span style="color:#710">'</span></span>]
</pre></div>
</div>
</div>

<h2 id="a-touch-of-metaprogramming">A Touch of Metaprogramming</h2>

<p>Sweet, but how to do we get our jobs to actually follow this configuration file. Well, you may have noticed that all our jobs inherit from the BaseJob class. What’s all that about. Well, a lot of applications have some logging or stats that they want to attach to all the jobs. By having a base class that every job inherits from you can easily manage job-wide settings. And that’s exactly what we will do.</p>

<p>There’s a handy little method that every class in Ruby has called <a href="http://www.ruby-doc.org/core-2.0/Class.html#method-i-inherited"><code>#inherited</code></a>  Whenever we do <code>MyClass &lt; YourClass</code> inherited is called on YourClass with MyClass as the argument.</p>

<p>In our BaseJob class let’s add an <code>#inherited</code> method that will assign the queue to the class:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">BaseJob</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>  <span style="color:#777"># things that are common to all jobs go up here...</span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">inherited</span>(subclass)
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>    <span style="color:#777"># Lookup class specific settings from config/resque-pool.yml</span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>    subclass_config = <span style="color:#036;font-weight:bold">Resque</span>::<span style="color:#036;font-weight:bold">RESQUE_JOB_QUEUES</span>[subclass.name.underscore]
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    <span style="color:#777"># this is replaces having to do @queue = 'low-heavy' in the worker classes</span>
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>    subclass.instance_variable_set(<span style="color:#A60">:@queue</span>, <span style="color:#069">self</span>.resque_queue_name(subclass_config))
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>  <span style="color:#080;font-weight:bold">def</span> <span style="color:#069">self</span>.<span style="color:#06B;font-weight:bold">resque_queue_name</span>(subclass_config)
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>    <span style="color:#080;font-weight:bold">if</span> subclass_config.try(<span style="color:#A60">:[]</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">queue</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>      <span style="color:#080;font-weight:bold">return</span> subclass_config[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">queue</span><span style="color:#710">'</span></span>]
<span class="line-numbers"><a href="#n14" name="n14">14</a></span>    <span style="color:#080;font-weight:bold">else</span>
<span class="line-numbers"><a href="#n15" name="n15">15</a></span>      <span style="color:#080;font-weight:bold">return</span> <span style="color:#036;font-weight:bold">Resque</span>::<span style="color:#036;font-weight:bold">RESQUE_JOB_QUEUES</span>[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">default_queue</span><span style="color:#710">'</span></span>]
<span class="line-numbers"><a href="#n16" name="n16">16</a></span>    <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n17" name="n17">17</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n18" name="n18">18</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<h2 id="one-configuration-file-to-rule-them-all">One configuration file to rule them all</h2>

<p>And that’s it. Now we can add a new class without having to think about what queue it should be on. It’ll magically use the default queue.</p>


<p class='prev'>
<a class="previous" title="Next and Previous Links in Nanoc" href="/writing/next-previous-links-nanoc/">&larr; Previous</a>
</p>
<p class='next'>
<a class="next" title="Startups aren't for everyone" href="/writing/startups-arent-for-everyone/">Next &rarr;</a>
</p>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
 var disqus_developer = 1; // developer mode is on
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ecarmi'; // required: replace example with your forum shortname

  // The following are highly recommended additional parameters. Remove the slashes in front to use.
  var disqus_identifier = '/writing/manage-resque-jobs-yaml/';
  var disqus_title = 'Manage Resque Job Queues in YAML';
  var disqus_url = 'https://ecarmi.org/writing/manage-resque-jobs-yaml/';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</article>

</div>
<footer>
<div class='footer-div'>
<div class='footer-contents'>
<section>
<aside>
<h6>Whose site is this?</h6>
</aside>
<article>
<p>This is the digital abode of Evan Carmi. <a title="About" href="/about/">Moreover...</a>.</p>
</article>
</section>
<section>
<aside>
<h6>Have thoughts?</h6>
</aside>
<article>
<script async src='//easyform.io/assets/embed.js'></script>
<form id="contact-form" action="//easyform.io/e44d9aea04bbaadceb9cbb8a412116e1" method="POST">
  <input type="email" name="replyto" placeholder="Put your email here..." required>
  <textarea name="message" rows="2" placeholder="Put your opinion here..." required></textarea>
  <input type="text" name="_gotcha" style="display:none">
  <input type="hidden" name="subject" value="[submission] Hello from ecarmi.org" />
  <input type="submit" value="Send">
</form>
</article>
</section>
<section>
<aside>
<h6>How was the site made?</h6>
</aside>
<article>
<p>Evan Carmi designed and coded this site by hand with love in <a href="https://github.com/carmi/dotfiles/blob/master/.vimrc">Vim</a>.  It is powered by <a href="http://nanoc.stoneship.org/">Nanoc</a> and served by <a href="http://nginx.org/">Nginx</a> on the <a href="http://joyent.com/">Joyent Cloud</a>. The complete source code is <a href="https://github.com/carmi/ecarmi.org-nanoc">online</a>.</p>
</article>
</section>
</div>
<p class='social-links'>
<a title="Home" href="/"><i class="fa fa-home"></i></a>
<a title="Github" rel="me" href="https://github.com/carmi/"><i class="fa fa-github"></i></a>
<a title="Twitter" rel="me" href="https://twitter.com/ehc"><i class="fa fa-twitter"></i></a>
<a title="LinkedIn" rel="me" href="http://www.linkedin.com/in/evancarmi"><i class="fa fa-linkedin"></i></a>
</p>
</div>
</footer>

<!-- / Javascript -->
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src='/static/js/combined.js' type='text/javascript'></script>
<!-- GA -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-27458554-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End GA -->

<script type='text/javascript'>
jQuery(document).ready(function() {
jQuery("time.timeago").timeago();
});
</script>
</body>
</html>
