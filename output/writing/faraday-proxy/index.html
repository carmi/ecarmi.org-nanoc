<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<link href='/static/css/application.css' media='screen' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Alegreya:400italic,400,700|Inconsolata' rel='stylesheet' type='text/css'>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<script type="text/javascript">
    // first, create the object that contains
    // configuration variables
    MTIConfig = {};

    // next, add a variable that will control
    // whether or not FOUT will be prevented
    MTIConfig.EnableCustomFOUTHandler = true // true = prevent FOUT
</script>
<title>
Setup a Faraday Proxy | Evan Carmi
</title>
<link href="/writing/feed.xml" type="application/atom+xml" rel="alternate" title="Writing ATOM Feed">
<meta content='nanoc' name='generator'>
<meta content='Evan Carmi' name='author'>
<meta content='A slick monkey patch to pass all Faraday traffic through a proxy.' name='description'>
</head>
<body>
<div class='container'>
<header class='post'>
<div class='header-contents'>
<hgroup class='article-metadata'>
By
<span class='author'>
<a href='https://ecarmi.org'>
Evan Carmi
</a>
</span>
&#183;
<span class='post-date'>
Posted
<time class="timeago created-at" datetime="2014-02-08T00:00:00-08:00">February  8, 2014</time>
</span>
</hgroup>
<h1 class='title'>Setup a Faraday Proxy</h1>
</div>
</header>
<article class='post'>
<p>I like verbose logs. If I’m working with a service that ultimately communicates via HTTP, I like seeing the raw HTTP logs. I very often run a proxy in devlopment to look at raw HTTP traffic. Something like <a href="http://www.charlesproxy.com/">Charles</a> is easy to use for browser traffic. However, when you want to pass the traffic of a Ruby HTTP client through your proxy you need to do a bit of hacking. The normal method is to overwrite the <code>def connection</code> definition with a monkey patch where the client sets up an HTTP connection. <a href="http://stackoverflow.com/questions/11948656/omniauth-google-faraday-behind-the-proxy-how-setup-proxy/11953745#11953745">Something like this.</a></p>

<p>But I wanted a solution that was more general and didn’t require knowing about the client talking to Faraday. I also didn’t want to monkey patch the entire <code>Faraday::Connection</code> class. So I wrote up a little monkey patch that wraps the Faraday::Connection <code>initialize</code> method injecting in your proxy settings. If you toss this code into your app (if it’s a Rails app in an initializer) then all Faraday connections should go through your proxy. Cool!</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"> <a href="#n1" name="n1">1</a></span><span style="color:#036;font-weight:bold">OpenSSL</span>::<span style="color:#036;font-weight:bold">SSL</span>::<span style="color:#036;font-weight:bold">VERIFY_PEER</span> = <span style="color:#036;font-weight:bold">OpenSSL</span>::<span style="color:#036;font-weight:bold">SSL</span>::<span style="color:#036;font-weight:bold">VERIFY_NONE</span>
<span class="line-numbers"> <a href="#n2" name="n2">2</a></span>
<span class="line-numbers"> <a href="#n3" name="n3">3</a></span><span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">Faraday</span>
<span class="line-numbers"> <a href="#n4" name="n4">4</a></span>  <span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Connection</span>
<span class="line-numbers"> <a href="#n5" name="n5">5</a></span>    alias_method <span style="color:#A60">:old_initialize</span>, <span style="color:#A60">:initialize</span>
<span class="line-numbers"> <a href="#n6" name="n6">6</a></span>
<span class="line-numbers"> <a href="#n7" name="n7">7</a></span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(url = <span style="color:#069">nil</span>, options = {})
<span class="line-numbers"> <a href="#n8" name="n8">8</a></span>      proxy = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">http://127.0.0.1:3128</span><span style="color:#710">'</span></span>
<span class="line-numbers"> <a href="#n9" name="n9">9</a></span>      (url.is_a?(<span style="color:#036;font-weight:bold">Hash</span>) ? url : options).merge!(<span style="color:#606">proxy</span>: proxy)
<span class="line-numbers"><strong><a href="#n10" name="n10">10</a></strong></span>
<span class="line-numbers"><a href="#n11" name="n11">11</a></span>      old_initialize(url, options)
<span class="line-numbers"><a href="#n12" name="n12">12</a></span>    <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n13" name="n13">13</a></span>  <span style="color:#080;font-weight:bold">end</span>
<span class="line-numbers"><a href="#n14" name="n14">14</a></span><span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Change line 8 to be whatever path and port your proxy is running on.</p>

<p>You should get a SSL verification error if you are making HTTPS calls to external services. You can disable this SSL verification during debugging with line 1.</p>

<p class='prev'>
<a class="previous" title="A Hacker's Guide to Health Insurance in the USA" href="/writing/hackers-guide-to-healthcare/">&larr; Previous</a>
</p>
<p class='next'>
<a class="next" title="How to Apply for an Internship" href="/writing/apply-for-internship/">Next &rarr;</a>
</p>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
 var disqus_developer = 1; // developer mode is on
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'ecarmi'; // required: replace example with your forum shortname

  // The following are highly recommended additional parameters. Remove the slashes in front to use.
  var disqus_identifier = '/writing/faraday-proxy/';
  var disqus_title = 'Setup a Faraday Proxy';
  var disqus_url = 'https://ecarmi.org/writing/faraday-proxy/';

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</article>

</div>
<footer>
<div class='footer-div'>
<div class='footer-contents'>
<section>
<aside>
<h6>Whose site is this?</h6>
</aside>
<article>
<p>This is the digital abode of Evan Carmi. <a title="About" href="/about/">Moreover...</a>.</p>
</article>
</section>
<section>
<aside>
<h6>Have thoughts?</h6>
</aside>
<article>
<form id="contact-form" action="//murmuring-gorge-6133.herokuapp.com/c7fb810ab62eafa93d1683aa5e3d9877" method="POST">
    <input type="email" name="replyto" placeholder="Place email here...">
    <textarea name="message" rows="1" placeholder="Place opinion here..."></textarea>
    <input type="text" name="_gotcha" style="display:none">
    <input type="hidden" name="subject" value="[submission] Hello from ecarmi.org" />
    <input type="submit" value="Send">
</form>
</article>
</section>
<section>
<aside>
<h6>How was the site made?</h6>
</aside>
<article>
<p>Evan Carmi designed and coded this site by hand with love in <a href="https://github.com/carmi/dotfiles/blob/master/.vimrc">Vim</a>.  It is powered by <a href="http://nanoc.stoneship.org/">Nanoc</a> and served by <a href="http://nginx.org/">Nginx</a> on the <a href="http://joyent.com/">Joyent Cloud</a>. The complete source code is <a href="https://github.com/carmi/ecarmi.org-nanoc">online</a>.</p>
</article>
</section>
</div>
<p class='social-links'>
<a title="Home" href="/"><i class="fa fa-home"></i></a>
<a title="Github" rel="me" href="https://github.com/carmi/"><i class="fa fa-github"></i></a>
<a title="Twitter" rel="me" href="https://twitter.com/ehc"><i class="fa fa-twitter"></i></a>
<a title="LinkedIn" rel="me" href="http://www.linkedin.com/in/evancarmi"><i class="fa fa-linkedin"></i></a>
</p>
</div>
</footer>

<!-- / Javascript -->
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src='/static/js/combined.js' type='text/javascript'></script>
<!-- GA -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-27458554-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End GA -->

<script type='text/javascript'>
jQuery(document).ready(function() {
jQuery("time.timeago").timeago();
});
</script>
</body>
</html>
